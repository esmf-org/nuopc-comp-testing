# nuopc-comp-testing

This action allows testing model component in a isolated enviroment outside of any Earth system modeling application. In this case, the model component is forced by data components provided by the Community Data Models for Earth Prediction Systems ([CDEPS](https://github.com/ESCOMP/CDEPS)) to create simple yet realistic test configuration. This approach allow to test the ESMF/NUOPC "cap" easily and test it along with the development automatically.

The action mainly includes following features:

- Installs component dependencies such as third-party libraries required to build model component through the use of [Spack package manager](https://github.com/spack/spack). The list of dependencies need to include the [ESMF](https://github.com/esmf-org/esmf) library.

- Creates very simple executable that includes the active component as well as the data model through the use of Earth System Model eXecutable layer ([ESMX](https://github.com/esmf-org/esmf/tree/develop/src/addon/ESMX)). In this case, CDEPS provides the data component capability. 

- Prepares run directory for testing specified configuration.
  - Downloads and stages input data and cache it using [cache](https://github.com/actions/cache) action
  - Creates namelist files on-the-fly by leveraging set of Python script and imporved version of [ParamGen](https://github.com/ESMCI/cime/tree/master/CIME/ParamGen) by processing YAML test configuration files

- Runs the configured testing applications

- Pushes specified model output to GitHub artifacts

- Creates baseline and store it as GitHub cache. Then, checks it against the existing baseline if it is created before. The action does not store all the data generated by the output. It just calculates the MD5 hases of each file that is selected for the baseline generation (`baseline_files` argument) and store only those hases in simple ASCII file.

## Documentation

## What's New

### v1

* Added caching support for dependency installations, inputs and baseline
* Added support to use `Baseline Change` label for PRs to pass baseline checking against the existing one
* Both driver and component could have multiple `input` section in test definition `.yml` files 

## Usage

### Pre-requisites

Create a workflow `.yml` file in your repositories under `.github/workflows` directory. An [example workflow](#example-component-testing-workflow) is available below. For more information, reference the GitHub Help Documentation for [Creating a workflow file](https://help.github.com/en/articles/configuring-a-workflow#creating-a-workflow-file).

Create a top level driver `.yml` file in your repositories under `.github/workflows/tests` directory. This will point component specific `.yml` files as well as definition of driver specific input and namelist files. 

Create components `.yml` file in your repositories under `.github/workflows/tests/[NAME OF THE DRIVER YAML FILE]` directory. These files will include information about definition of required input file/s and namelist files for the specific model component.

### Inputs

* `app_install_dir` - An optional path of installation directory for test configuration. The deafult value is set to `${{ github.workspace }}/app`.
* `architecture` - An optional value for Spack target architecture. The default value is set to `x86_64_v4`.
* `artifacts_files` - A optional list of files, directories, and wildcard patterns to save specified files as artifacts. The deafult value is set to `None` and the action will not save any artifacts after action ends.
* `artifacts_retention_period` - An optional number to specify artifacts retention period. The default value is set to 2-days.
* `baseline_files` - A optional list of files, directories, and wildcard patterns to be used as a baseline. The deafult value is set to `None` and the action will not create baseline to check it in later runs.
* `cache_input_file_list` - A optional list of files, directories, and wildcard patterns to cache input files. The deafult value is set to `None`.
* `component_name` - A optional argument to specify component name. The deafult value is set to `${{ github.event.repository.name }}`.
* `component_build` - The list of shell commands to build the component. This is required since the GitHub Action do not know anything about the component build system and requirements.
* `component_module_name` - The Fortran module name of the component that will be tested. This argument is currently required but it would be a part of the user provided YAML files.
* `data_component_name` - The optional name of data component that will be used to force the component. The valid values are `datm` (default), `dice`, `dlnd`, `docn`, `drof` and `dwav`. It would be a part of the user provided YAML files in the future.
* `dependencies` - The list of dependencies that are used to build the application. Since Spack is used to install dependencies the given packages needs to be part of the Spack distribution. The list of packages can be seen in [here](https://packages.spack.io). The ESMf package (`esmf@8.4.0b15+parallelio`) needs to be added to the list. 
* `dependencies_install_dir` - An optional path of installation directory for dependencies. The default value is set to `~/.spack-ci`.
* `test_definition` - The top level YAML file that describes the test. This is required.

#### Environment Variables

* `GH_TOKEN` - This needs to be set to `${{ github.token }}`. It will aloow to run `gh` command in the composite action to access list of available baseline caches and find the correct baseline to check it. 

### Outputs

In this version there has no output for top level action resides in the component repository.

### Example component testing workflow

#### Describing configuration of component testing through using YAML specification

The description of the component testing is defined via set of YAML files. The [Noah-MP land model](https://github.com/NOAA-EMC/noahmp) example will be used in the rest of the document to give brief introduction about the YAML files, their structures and building GitHub Action to test the component . 

##### Top-level YAML file for driver

```yaml
components:
  drv:
    runseq:
      dt: 
        values: 360
      compA-to-compB:
        values: remapMethod=bilinear:unmappedaction=ignore:zeroregion=select:srcTermProcessing=0:termOrder:srcseq
      compB-to-compA: 
        values: remapMethod=bilinear:unmappedaction=ignore:zeroregion=select:srcTermProcessing=0:termOrder:srcseq
      compA:
      compB:
    input:
      field_table:
        protocol: wget
        end_point: 'https://raw.githubusercontent.com'
        files:
          - /ufs-community/ufs-weather-model/develop/tests/parm/fd_nems.yaml
    config:
      nuopc:
        name: esmxRun.config
        content:
          ESMX_attributes:
            Verbosity:
              values: high
          ALLCOMP_attributes:
            case_name:
              values: comp.test
            stop_n: 
              values: 1
            stop_option: 
              values: ndays
            stop_tod: 
              values: 0
            stop_ymd: 
              values: -999
            restart_n: 
              values: 1
            restart_option: 
              values: never
            restart_ymd: 
              values: -999
          no_group:
            ESMX_component_list:
              values: COMPA COMPB
            startTime:
              values: '2000-01-01T00:00:00'
            stopTime:
              values: '2000-01-02T00:00:00'
            logKindFlag:
              values: ESMF_LOGKIND_MULTI
            globalResourceControl:
              values: .true.
            ESMX_log_flush:
              values: .true.
            ESMX_field_dictionary: 
              values: fd.yaml
    
  compA: compA.yaml
  compB: compB.yaml
```

The top level driver `.yml` file includes information about [NUOPC run sequence](http://earthsystemmodeling.org/docs/release/latest/NUOPC_refdoc/node4.html#SECTION000411300000000000000), input files such as [NUOPC field dictionary](http://earthsystemmodeling.org/docs/release/latest/NUOPC_refdoc/node3.html#SECTION00032000000000000000), ESMX driver specific namelist file and its content and pointer for component specific `.yml` files.

* `runseq` - This section defines the NUOPC run sequence to run the components and interaction among them. `dt` is used to define coupling interval (in seconds). The rest of the content of this section is used to define the run sequence. The unmappedaction=ignore:zeroregion=select:srcTermProcessing=0:termOrder:srcseq` part ensures the bit-to-bit reproducabilty for sipecified interpolation type, which is defined as `bilinear` in this example.

* `input` - These sections define the set of inputs that are required for the driver. There could be multiple entries under this section. For example, `field_table` section basically downloads NUOPC field dictionary from UFS Weather Model repository using `wget` command. The [Python script](https://github.com/uturuncoglu/nuopc-comp-testing/blob/main/scripts/get_input.py) that is used to download data also supports other protocols such as `ftp`, `wget`, `s3` and `s3cli`. The optional `target_directory` argument also enable to specify target directory (both absolute and realtive paths are supported) for the retrieved data. 

* `config` - This section mainly used to create namelist files. It supports multiple formats: (1) Standard Fortran namelist (`nml:`)  and, (2) ESMF config (`nuopc:`) format
   
   - `name:` This section basically defines the name of the namelist file and if any other `.yml` file (driver or component ones) has section with same file name, then the content are appended to the existing namelist file. With this approach, each component could append their component specific namelist options for example top level driver ESMF config file.
   
   - `content:` This section mainly includes the content of the namelist file and uses format defined by the ParamGen tool. It is also possible to overwrite the content of this section by defining environment variable with the same name. To that end, the same file can be used for different application by changing set of namelist variables on-the-fly. 
   
> **Note**
> It is also possible to add multiple namelist files in the same format by modifying namelist tag as `nuopc1:`, `nuopc2:` etc.

* `comp*` - This section defines the pointers for component model (incl. CDEPS) specific `.yml` files. The underlying infrastructure follow the file defined in here and read with the YAML parser to include the information defined in those files into internal Python dictionary that is used to parse information and perfrom the different operations. 

##### YAML files for model components

**compA.yaml**

```yaml
---
input:
  fixed:
    protocol: s3
    end_point: noaa-ufs-regtests-pds
    files:
      - input-data-20221101/FV3_fix_tiled/C96/C96.maximum_snow_albedo.tile1.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.maximum_snow_albedo.tile2.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.maximum_snow_albedo.tile3.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.maximum_snow_albedo.tile4.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.maximum_snow_albedo.tile5.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.maximum_snow_albedo.tile6.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.slope_type.tile1.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.slope_type.tile2.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.slope_type.tile3.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.slope_type.tile4.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.slope_type.tile5.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.slope_type.tile6.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.soil_type.tile1.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.soil_type.tile2.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.soil_type.tile3.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.soil_type.tile4.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.soil_type.tile5.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.soil_type.tile6.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.substrate_temperature.tile1.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.substrate_temperature.tile2.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.substrate_temperature.tile3.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.substrate_temperature.tile4.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.substrate_temperature.tile5.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.substrate_temperature.tile6.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_greenness.tile1.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_greenness.tile2.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_greenness.tile3.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_greenness.tile4.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_greenness.tile5.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_greenness.tile6.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_type.tile1.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_type.tile2.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_type.tile3.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_type.tile4.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_type.tile5.nc
      - input-data-20221101/FV3_fix_tiled/C96/C96.vegetation_type.tile6.nc
      - input-data-20221101/FV3_input_data/INPUT/C96_grid.tile1.nc
      - input-data-20221101/FV3_input_data/INPUT/C96_grid.tile2.nc
      - input-data-20221101/FV3_input_data/INPUT/C96_grid.tile3.nc
      - input-data-20221101/FV3_input_data/INPUT/C96_grid.tile4.nc
      - input-data-20221101/FV3_input_data/INPUT/C96_grid.tile5.nc
      - input-data-20221101/FV3_input_data/INPUT/C96_grid.tile6.nc
      - input-data-20221101/FV3_input_data/INPUT/grid_spec.nc
      - input-data-20221101/FV3_input_data/INPUT/oro_data.tile1.nc
      - input-data-20221101/FV3_input_data/INPUT/oro_data.tile2.nc
      - input-data-20221101/FV3_input_data/INPUT/oro_data.tile3.nc
      - input-data-20221101/FV3_input_data/INPUT/oro_data.tile4.nc
      - input-data-20221101/FV3_input_data/INPUT/oro_data.tile5.nc
      - input-data-20221101/FV3_input_data/INPUT/oro_data.tile6.nc    
    target_directory: 'INPUT'
  ic:
    protocol: wget
    end_point: 'https://raw.githubusercontent.com'
    files:
      - /esmf-org/noahmp/develop/.github/workflows/data/C96.initial.tile1.nc
      - /esmf-org/noahmp/develop/.github/workflows/data/C96.initial.tile2.nc
      - /esmf-org/noahmp/develop/.github/workflows/data/C96.initial.tile3.nc
      - /esmf-org/noahmp/develop/.github/workflows/data/C96.initial.tile4.nc
      - /esmf-org/noahmp/develop/.github/workflows/data/C96.initial.tile5.nc
      - /esmf-org/noahmp/develop/.github/workflows/data/C96.initial.tile6.nc
    target_directory: 'INPUT'
config:
  nuopc:
    name: esmxRun.config
    content: 
      no_group:
        LND_model:
          values: noahmp
        LND_petlist: 
          values: 0-5
      LND_attributes:
        Verbosity:
          values: 0
        Diagnostic:
          values: 0
        mosaic_file:
          values: INPUT/grid_spec.nc
        input_dir:
          values: INPUT/
        ic_type:
          values: custom
        num_soil_levels:
          values: 4
        forcing_height:
          values: 10
        soil_level_thickness:
          values: 0.10:0.30:0.60:1.00
        soil_level_nodes:
          values: 0.05:0.25:0.70:1.50
        dynamic_vegetation_option:
          values: 4
        canopy_stomatal_resistance_option:
          values: 2
        soil_wetness_option:
          values: 1
        runoff_option:
          values: 1
        surface_exchange_option:
          values: 3
        supercooled_soilwater_option:
          values: 1
        frozen_soil_adjust_option:
          values: 1
        radiative_transfer_option:
          values: 3
        snow_albedo_option:
          values: 1
        precip_partition_option:
          values: 4
        soil_temp_lower_bdy_option:
          values: 2
        soil_temp_time_scheme_option:
          values: 3
        surface_evap_resistance_option:
          values: 1
        glacier_option:
          values: 1
        surface_thermal_roughness_option:
          values: 2
        output_freq:
          values: 10800
        has_export:
          values: .false.
  nml:
    name: input.nml
    content:
      fms_nml:
        clock_grain:
          values: "'ROUTINE'"
        clock_flags:
          values: "'NONE'"
        domains_stack_size:
          values: 5000000
        stack_size:
          values: 0
```

