# nuopc-comp-testing

This action allows testing model component in a isolated enviroment outside of any Earth system modeling application. In this case, the model component is forced by data components provided by the Community Data Models for Earth Prediction Systems ([CDEPS](https://github.com/ESCOMP/CDEPS)) to create simple yet realistic test configuration. This approach allow to test the ESMF/NUOPC "cap" easily and test it along with the development automatically.

The action mainly includes following features:

- Installs component dependencies such as third-party libraries required to build model component through the use of [Spack package manager](https://github.com/spack/spack). The list of dependencies need to include the [ESMF](https://github.com/esmf-org/esmf) library.

- Creates very simple executable that includes the active component as well as the data model through the use of Earth System Model eXecutable layer ([ESMX](https://github.com/esmf-org/esmf/tree/develop/src/addon/ESMX)). In this case, CDEPS provides the data component capability. 

- Prepares run directory for testing specified configuration.
  - Downloads and stages input data and cache it using [cache](https://github.com/actions/cache) action
  - Creates namelist files on-the-fly by leveraging set of Python script and imporved version of [ParamGen](https://github.com/ESMCI/cime/tree/master/CIME/ParamGen) by processing YAML test configuration files

- Runs the configured testing applications

- Pushes specified model output to GitHub artifacts

- Creates baseline and store it as GitHub cache. Then, checks it against the existing baseline if it is created before. The action does not store all the data generated by the output. It just calculates the MD5 hases of each file that is selected for the baseline generation (`baseline_files` argument) and store only those hases in simple ASCII file.

## Documentation

## What's New

### v1

* Added caching support for dependency installations, inputs and baseline

## Usage

### Pre-requisites

Create a workflow `.yml` file in your repositories under `.github/workflows` directory. An [example workflow](#example-component-testing-workflow) is available below. For more information, reference the GitHub Help Documentation for [Creating a workflow file](https://help.github.com/en/articles/configuring-a-workflow#creating-a-workflow-file).

Create a top level driver `.yml` file in your repositories under `.github/workflows/tests` directory. This will point component specific `.yml` files as well as definition of driver specific input and namelist files. 

Create components `.yml` file in your repositories under `.github/workflows/tests/[NAME OF THE DRIVER YAML FILE]` directory. These files will include information about definition of required input file/s and namelist files for the specific model component.

### Inputs

* `app_install_dir` - An optional path of installation directory for test configuration. The deafult value is set to `${{ github.workspace }}/app`.
* `architecture` - An optional value for Spack target architecture. The default value is set to `x86_64_v4`.
* `artifacts_files` - A optional list of files, directories, and wildcard patterns to save specified files as artifacts. The deafult value is set to `None` and the action will not save any artifacts after action ends.
* `artifacts_retention_period` - An optional number to specify artifacts retention period. The default value is set to 2-days.
* `baseline_files` - A optional list of files, directories, and wildcard patterns to be used as a baseline. The deafult value is set to `None` and the action will not create baseline to check it in later runs.
* `cache_input_file_list` - A optional list of files, directories, and wildcard patterns to cache input files. The deafult value is set to `None`.
* `component_name` - A optional argument to specify component name. The deafult value is set to `${{ github.event.repository.name }}`.
* `component_build` - The list of shell commands to build the component. This is required since the GitHub Action do not know anything about the component build system and requirements.
* `component_module_name` - The Fortran module name of the component that will be tested. This argument is currently required but it would be a part of the user provided YAML files.
* `data_component_name` - The optional name of data component that will be used to force the component. The valid values are `datm` (default), `dice`, `dlnd`, `docn`, `drof` and `dwav`. It would be a part of the user provided YAML files in the future.
* `dependencies` - The list of dependencies that are used to build the application. Since Spack is used to install dependencies the given packages needs to be part of the Spack distribution. The list of packages can be seen in [here](https://packages.spack.io). The ESMf package (`esmf@8.4.0b15+parallelio`) needs to be added to the list. 
* `dependencies_install_dir` - An optional path of installation directory for dependencies. The default value is set to `~/.spack-ci`.
* `test_definition` - The top level YAML file that describes the test. This is required.

#### Environment Variables

* `GH_TOKEN` - This needs to be set to `${{ github.token }}`. It will aloow to run `gh`command in the composite action to access list of available baseline caches. 

### Outputs

In this version there has no output for top level action resides in the component repository.

### Example component testing workflow

#### Describing configuration of component testing through using YAML specification

The description of the component testing (i.e., input files required for both CDEPS and model component and namelist files) is defined via set of YAML files. In this case, test could have following YAML files,

* Top-level YAML file for driver
